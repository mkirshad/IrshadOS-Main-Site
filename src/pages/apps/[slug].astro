---
export const prerender = false;

import Badge from "../../components/Badge.astro";
import Container from "../../components/Container.astro";
import SiteLayout from "../../layouts/SiteLayout.astro";
import { getAppDetail } from "../../lib/catalog";

const slug = Astro.params.slug;
if (!slug) throw new Response(null, { status: 404 });

const data = await getAppDetail(slug);
if (!data) throw new Response(null, { status: 404 });

const app = data.kind === "api" ? data.app : data.app;
const rendered = data.kind === "local" ? await data.entry.render() : null;

const appSchema = {
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  name: app.name,
  url: new URL(`/apps/${app.slug}`, Astro.site ?? Astro.url).toString(),
  applicationCategory: app.tags[0] ?? "ProductivityApplication",
  operatingSystem: "Web",
  offers:
    app.status === "live" && app.url
      ? {
          "@type": "Offer",
          price: "0",
          priceCurrency: "USD",
          url: app.url,
        }
      : undefined,
};
---

<SiteLayout title={app.name} description={app.short_description} schema={appSchema}>
  <section class="bg-white">
    <Container class="grid gap-8 py-12">
      <a href="/apps" class="no-underline text-sm font-semibold text-ink-700 hover:text-ink-900">
        ← Back to Apps
      </a>

      <div class="flex flex-col gap-6 md:flex-row md:items-start md:justify-between">
        <div class="flex items-start gap-4">
          <div class="grid size-14 place-items-center overflow-hidden rounded-2xl bg-ink-50 ring-1 ring-inset ring-ink-100">
            {app.icon ? (
              <img src={app.icon} alt="" class="h-full w-full object-cover" loading="lazy" />
            ) : (
              <span class="text-base font-semibold text-ink-700" aria-hidden="true">
                {app.name.slice(0, 2).toUpperCase()}
              </span>
            )}
          </div>
          <div class="grid gap-2">
            <h1 class="text-3xl font-semibold tracking-tight text-ink-950">{app.name}</h1>
            <p class="text-sm leading-relaxed text-ink-600">{app.short_description}</p>
            <div class="flex flex-wrap items-center gap-2">
              <Badge variant={app.status === "live" ? "success" : "warning"}>
                {app.status === "live" ? "Live" : "Coming soon"}
              </Badge>
              {app.tags.slice(0, 6).map((t) => (
                <span class="rounded-full bg-ink-50 px-2 py-0.5 text-xs font-medium text-ink-700">
                  {t}
                </span>
              ))}
            </div>
          </div>
        </div>

        <div class="grid gap-2 rounded-2xl border border-ink-100 bg-ink-50/40 p-5 md:w-80">
          <h2 class="text-sm font-semibold text-ink-900">Links</h2>
          {app.url ? (
            <a href={app.url} class="text-sm font-medium text-ink-900" rel="noreferrer">
              Open app →
            </a>
          ) : (
            <p class="text-sm text-ink-600">App link will appear here after launch.</p>
          )}
          {app.repo_url ? (
            <a href={app.repo_url} class="text-sm font-medium text-ink-900" rel="noreferrer">
              Repository →
            </a>
          ) : (
            <p class="text-sm text-ink-600">Repository link (optional).</p>
          )}
        </div>
      </div>

      <div class="grid gap-8 md:grid-cols-3">
        <article class="prose prose-zinc max-w-none md:col-span-2">
          {rendered ? (
            <rendered.Content />
          ) : (
            <>
              <h2>Overview</h2>
              <p>{app.long_description ?? app.short_description}</p>
              <h2>Features</h2>
              <ul>
                <li>Feature list placeholder</li>
                <li>Screenshot placeholders</li>
                <li>Links and release status</li>
              </ul>
            </>
          )}
        </article>

        <aside class="grid gap-4">
          <div class="rounded-2xl border border-ink-100 bg-white p-5">
            <h2 class="text-sm font-semibold text-ink-900">Screenshots</h2>
            <div class="mt-3 grid gap-3">
              <div class="aspect-[16/10] rounded-xl bg-gradient-to-br from-ink-50 to-white ring-1 ring-inset ring-ink-100" />
              <div class="aspect-[16/10] rounded-xl bg-gradient-to-br from-ink-50 to-white ring-1 ring-inset ring-ink-100" />
              <div class="aspect-[16/10] rounded-xl bg-gradient-to-br from-ink-50 to-white ring-1 ring-inset ring-ink-100" />
            </div>
            <p class="mt-3 text-xs text-ink-600">Screenshots will be added as the app ships.</p>
          </div>
        </aside>
      </div>
    </Container>
  </section>
</SiteLayout>
